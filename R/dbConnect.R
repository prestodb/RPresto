# Copyright (c) Meta Platforms, Inc. and affiliates.
# All rights reserved.
#
# This source code is licensed under the BSD-style license found in the
# LICENSE file in the root directory of this source tree.

#' @include PrestoDriver.R PrestoConnection.R
NULL

#' @param drv A driver object generated by \code{\link{Presto}}
#' @param catalog The catalog to be used
#' @param schema The schema to be used
#' @param user The current user
#' @param host The presto host to connect to
#' @param port Port to use for the connection
#' @param source Source to specify for the connection
#' @param session.timezone Time zone to use for the connection. Presto returns
#'          timestamps without time zones with respect to this value. The time
#'          arithmetic (e.g. adding hours) will also be done in the given time
#'          zone. See the session.timezone tests for examples.
#' @param parameters A \code{\link{list}} of extra parameters to be passed in
#'          the \sQuote{X-Presto-Session} header
#' @param use.trino.headers A boolean to indicate whether Trino request headers
#'          should be used. Default to FALSE.
#' @param ... currently ignored
#' @return [dbConnect] A \code{\linkS4class{PrestoConnection}} object
#' @export
#' @rdname Presto
#' @examples
#' \dontrun{
#'   conn <- dbConnect(Presto(), catalog = 'hive', schema = 'default',
#'                     user = 'onur', host = 'localhost', port = 8080,
#'                     session.timezone='US/Eastern')
#'   dbListTables(conn, '%_iris')
#'   dbDisconnect(conn)
#' }
setMethod('dbConnect',
  'PrestoDriver',
  function(
    drv,
    catalog,
    schema,
    user,
    host = 'localhost',
    port = 8080,
    source = getPackageName(),
    session.timezone='UTC',
    parameters = list(),
    use.trino.headers=FALSE,
    extra.credentials="",
    ...
  ) {
    port <- suppressWarnings(as.integer(port))
    if (!length(port) == 1 || is.na(port)) {
      stop("Please specify a port as an integer")
    }

    conn <- new('PrestoConnection',
      catalog=catalog,
      schema=schema,
      user=user,
      host=host,
      port=port,
      source=source,
      session.timezone=session.timezone,
      use.trino.headers=use.trino.headers,
      session=PrestoSession$new(parameters),
      extra.credentials=extra.credentials
    )
    return(conn)
  }
)
